<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ebook Search</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #000000;
            --white: #ffffff;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            padding: 20px 60px;
            border-bottom: 1px solid var(--gray-200);
            flex-shrink: 0;
            background: var(--white);
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .header-section {
            flex-shrink: 0;
        }

        .header-section h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
            margin: 0 0 2px 0;
            line-height: 1.2;
        }

        .header-section p {
            font-size: 12px;
            color: var(--gray-600);
            margin: 0;
            line-height: 1.2;
        }

        .search-section {
            flex: 1;
            margin-bottom: 0;
        }

        .search-form {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 14px 16px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            color: var(--black);
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .search-input::placeholder {
            color: var(--gray-400);
        }

        .file-type-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .filter-section {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .stats-section {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            color: var(--gray-600);
        }

        .stats-section .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 8px;
            background: var(--gray-50);
            border-radius: 4px;
            min-width: 60px;
        }

        .stats-section .stat-number {
            font-weight: 600;
            color: var(--black);
            font-size: 14px;
        }

        .stats-section .stat-label {
            font-size: 10px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-timing {
            font-size: 11px;
            color: var(--gray-500);
            margin-left: 8px;
            font-style: italic;
        }

        .filter-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
            margin-right: 8px;
        }

        .results-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }

        .results-per-page-select {
            padding: 6px 8px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .results-per-page-select:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .results-per-page-select:hover {
            border-color: var(--gray-400);
        }

        .file-type-button {
            padding: 6px 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .file-type-button.active {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }

        .file-type-button:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
        }

        .file-type-button.active:hover {
            background: var(--gray-800);
            border-color: var(--gray-800);
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            flex: 1;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .sidebar {
            background: var(--gray-50);
            padding: 30px;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            height: 100%;
        }

        .sidebar-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 14px;
            color: var(--gray-600);
        }

        .catalog-info {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .catalog-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--black);
        }

        .catalog-info p {
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .catalog-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .content {
            padding: 30px 60px;
            background: var(--white);
            overflow-y: auto;
            height: 100%;
        }

        .btn {
            padding: 14px 24px;
            border: 1px solid var(--black);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }

        .btn-primary:hover {
            background: var(--gray-800);
            border-color: var(--gray-800);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border-color: var(--gray-300);
            font-size: 13px;
            padding: 10px 16px;
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-small {
            font-size: 11px;
            padding: 6px 10px;
        }

        .btn-danger {
            background: var(--white);
            color: var(--black);
            border-color: var(--gray-300);
            font-size: 12px;
            padding: 8px 12px;
        }

        .btn-danger:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .directory-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--black);
        }

        .directory-add {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .directory-add input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .directory-add input:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .directory-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .directory-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .directory-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .directory-item.invalid {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .directory-path {
            flex: 1;
            word-break: break-all;
            margin-right: 12px;
            color: var(--gray-700);
        }

        .directory-item.invalid .directory-path {
            color: #dc2626;
        }

        .directory-remove-btn {
            font-size: 11px;
            padding: 4px 8px;
        }

        .search-status {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .stats {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--black);
            display: block;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .results {
            display: grid;
            gap: 16px;
        }

        .results-list {
            display: grid;
            gap: 8px;
        }

        .result-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            padding: 12px 16px;
            transition: all 0.2s ease;
        }

        .result-item:hover {
            border-color: var(--gray-400);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .result-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 6px;
            gap: 12px;
        }

        .result-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
            margin: 0;
            word-break: break-word;
            flex: 1;
            line-height: 1.3;
        }

        .result-meta-top {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .result-score {
            background: var(--black);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }

        .result-size {
            font-weight: 500;
            color: var(--gray-600);
            font-size: 11px;
        }

        .result-type {
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .result-path {
            color: var(--gray-500);
            font-size: 11px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            word-break: break-all;
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-path-text {
            flex: 1;
        }

        .copy-path-btn {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 9px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            line-height: 1;
        }

        .copy-path-btn:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
            color: var(--gray-800);
        }

        .copy-path-btn:active {
            background: var(--gray-300);
        }

        .copy-path-btn.copied {
            background: #dcfce7;
            border-color: #bbf7d0;
            color: #166534;
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-top: 1px solid var(--gray-200);
            margin-top: 16px;
        }

        .pagination-container:first-child {
            border-top: none;
            margin-top: 0;
            padding-top: 0;
        }

        .pagination-info {
            font-size: 13px;
            color: var(--gray-600);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-pagination {
            padding: 6px 12px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: auto;
        }

        .btn-pagination:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-pagination.active {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }

        .btn-pagination:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-ellipsis {
            padding: 6px 8px;
            color: var(--gray-400);
            font-size: 12px;
        }

        .message {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message.success {
            background: #f0f9ff;
            color: #0c4a6e;
            border: 1px solid #bae6fd;
        }

        .message.info {
            background: #f8fafc;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-600);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--black);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 280px 1fr;
            }
            
            .top-bar {
                padding: 16px 40px;
                gap: 30px;
            }
            
            .header-section h1 {
                font-size: 1.3rem;
            }
            
            .content {
                padding: 20px 40px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid var(--gray-200);
                height: auto;
                max-height: 40vh;
            }
            
            .top-bar {
                padding: 12px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .header-section {
                align-self: flex-start;
            }
            
            .search-section {
                width: 100%;
            }
            
            .content {
                padding: 16px 20px;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .file-type-filters {
                flex-wrap: wrap;
            }
        }

        .directory-info p {
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top search bar -->
        <div class="top-bar">
            <div class="header-section">
                <h1>Ebook Search</h1>
                <p>Digital Library Manager</p>
            </div>

            <div class="search-section">
                <form class="search-form" onsubmit="searchBooks(event)">
                    <input type="text" id="search-query" class="search-input" 
                           placeholder="Search by title, author, or keywords">
                    <button type="submit" class="btn btn-primary">Search</button>
                </form>
                
                <div class="file-type-filters">
                    <div class="filter-section">
                        <span class="filter-label">Filter by type:</span>
                        <div id="file-type-buttons">
                            <!-- File type buttons will be loaded here -->
                        </div>
                        <div class="results-per-page">
                            <label for="results-per-page-select" class="filter-label">Per page:</label>
                            <select id="results-per-page-select" class="results-per-page-select" onchange="changeResultsPerPage(this.value)">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="stats-section" id="inline-stats" style="display: none;">
                        <!-- Inline stats will be displayed here -->
                    </div>
                </div>
                
                <div class="search-status" id="search-status"></div>
            </div>
        </div>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="catalog-info">
                    <h4>Catalog Status</h4>
                    <div id="catalog-status">
                        <p>Loading catalog information...</p>
                    </div>
                    <div class="catalog-actions">
                        <button class="btn btn-secondary btn-small" onclick="forceBuildCatalog()">Rebuild Catalog</button>
                    </div>
                </div>

                <div class="directory-section">
                    <h3>Search directories</h3>
                    
                    <div class="directory-add">
                        <input type="text" id="new-directory" placeholder="/path/to/books">
                        <button class="btn btn-secondary" onclick="addDirectory()">Add</button>
                    </div>

                    <div class="directory-actions">
                        <button class="btn btn-secondary" onclick="resetDirectories()">Reset</button>
                        <button class="btn btn-danger" onclick="clearDirectories()">Clear</button>
                    </div>

                    <div id="directory-list" class="directory-list">
                        <!-- Directories will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="content">
                <div id="messages"></div>
                <div id="results" class="results"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 1;
        let resultsPerPage = 20;
        let filteredResults = [];
        let activeFileTypes = new Set(); // Track active file type filters

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDirectories();
            loadCatalogInfo();
            // Don't load file types on startup - they'll be built from search results
        });

        // Load catalog information
        async function loadCatalogInfo() {
            try {
                const response = await fetch('/catalog/metadata');
                const data = await response.json();
                
                const statusDiv = document.getElementById('catalog-status');
                
                if (data.success && data.metadata && Object.keys(data.metadata).length > 0) {
                    const lastRefresh = new Date(data.metadata.refresh_date);
                    const totalBooks = data.metadata.total_books || 0;
                    const buildTime = data.metadata.build_time_seconds || 0;
                    
                    // Calculate age
                    const now = new Date();
                    const ageMs = now - lastRefresh;
                    const ageDays = Math.floor(ageMs / (1000 * 60 * 60 * 24));
                    const ageHours = Math.floor((ageMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const ageMinutes = Math.floor((ageMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let ageText;
                    if (ageDays > 0) {
                        ageText = `${ageDays} day${ageDays > 1 ? 's' : ''} ago`;
                    } else if (ageHours > 0) {
                        ageText = `${ageHours} hour${ageHours > 1 ? 's' : ''} ago`;
                    } else if (ageMinutes > 0) {
                        ageText = `${ageMinutes} minute${ageMinutes > 1 ? 's' : ''} ago`;
                    } else {
                        ageText = 'Just now';
                    }
                    
                    statusDiv.innerHTML = `
                        <p><strong>${totalBooks}</strong> books cataloged</p>
                        <p>Age: ${ageText}</p>
                        <p>Build time: ${buildTime}s</p>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <p>No catalog found</p>
                        <p>Click "Rebuild Catalog" to create</p>
                    `;
                }
            } catch (error) {
                document.getElementById('catalog-status').innerHTML = `
                    <p>Error loading catalog info</p>
                `;
            }
        }

        // Build file type buttons from current search results
        function buildFileTypeButtons(results) {
            const container = document.getElementById('file-type-buttons');
            container.innerHTML = '';
            
            if (!results || results.length === 0) {
                return;
            }
            
            // Count file types in current results
            const typeCounts = {};
            results.forEach(book => {
                const ext = book.extension.toLowerCase();
                typeCounts[ext] = (typeCounts[ext] || 0) + 1;
            });
            
            // Sort by count (descending)
            const sortedTypes = Object.entries(typeCounts)
                .sort(([,a], [,b]) => b - a);
            
            // Only show types that have results
            sortedTypes.forEach(([ext, count]) => {
                if (count > 0) {
                    const button = document.createElement('span');
                    button.className = 'file-type-button';
                    // Check if this type is currently active
                    if (activeFileTypes.has(ext)) {
                        button.classList.add('active');
                    }
                    button.textContent = `${ext.toUpperCase()} (${count})`;
                    button.onclick = () => toggleFileType(ext, button);
                    container.appendChild(button);
                }
            });
        }

        // Search books
        async function searchBooks(event) {
            event.preventDefault();
            
            const query = document.getElementById('search-query').value;
            const resultsDiv = document.getElementById('results');
            const inlineStatsDiv = document.getElementById('inline-stats');
            const searchStatus = document.getElementById('search-status');
            
            console.log('Starting search with query:', query);
            searchStatus.textContent = 'Searching your ebook library...';
            const searchStartTime = performance.now();
            
            // Show loading
            resultsDiv.innerHTML = `<div class="loading">Searching through your ebook collection...</div>`;
            inlineStatsDiv.style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('query', query);
                // Don't send file_types - we'll filter on the client side
                
                console.log('Sending request to /search');
                const response = await fetch('/search', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                const clientSearchTime = Math.round(performance.now() - searchStartTime);
                
                if (data.success) {
                    console.log('Search successful, results count:', data.results.length);
                    // Store all results globally for filtering
                    window.allResults = data.results;
                    window.allStats = data.stats;
                    window.serverSearchTime = data.search_time_ms || 0;
                    
                    // Reset active filters when new search is performed
                    activeFileTypes.clear();
                    
                    // Build file type buttons from search results
                    buildFileTypeButtons(data.results);
                    
                    // Apply current filters and display (will show all since filters are cleared)
                    applyFileTypeFilters();
                    
                    const timingText = `Found ${data.results.length} results <span class="search-timing">(${window.serverSearchTime}ms server, ${clientSearchTime}ms total)</span>`;
                    searchStatus.innerHTML = timingText;
                } else {
                    console.log('Search failed with message:', data.message);
                    showMessage(data.message, 'error');
                    resultsDiv.innerHTML = '';
                    inlineStatsDiv.style.display = 'none';
                    searchStatus.textContent = '';
                    // Clear file type buttons when no results
                    document.getElementById('file-type-buttons').innerHTML = '';
                }
            } catch (error) {
                console.error('Search error:', error);
                const clientSearchTime = Math.round(performance.now() - searchStartTime);
                showMessage('Search failed', 'error');
                resultsDiv.innerHTML = '';
                inlineStatsDiv.style.display = 'none';
                searchStatus.innerHTML = `Search failed <span class="search-timing">(${clientSearchTime}ms)</span>`;
                // Clear file type buttons on error
                document.getElementById('file-type-buttons').innerHTML = '';
            }
        }

        // Apply file type filters to current results
        function applyFileTypeFilters() {
            if (!window.allResults) return;
            
            filteredResults = window.allResults;
            
            // Filter results if file types are selected
            if (activeFileTypes.size > 0) {
                filteredResults = window.allResults.filter(book => 
                    activeFileTypes.has(book.extension.toLowerCase())
                );
            }
            
            // Reset to first page when filters change
            currentPage = 1;
            
            // Update stats for filtered results
            const filteredStats = { ...window.allStats };
            filteredStats.results_count = filteredResults.length;
            
            // Display inline stats
            displayInlineStats(filteredStats);
            
            // Display paginated filtered results
            displayPaginatedResults(filteredResults, filteredStats);
            
            // Update search status
            updateSearchStatus();
        }

        // Display inline stats in the filter row
        function displayInlineStats(stats) {
            const inlineStatsDiv = document.getElementById('inline-stats');
            
            if (stats.file_types && typeof stats.file_types === 'object') {
                const fileTypeCount = Object.keys(stats.file_types).length;
                inlineStatsDiv.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${stats.total_books || 0}</span>
                        <div class="stat-label">Books</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.total_size_gb || '0.0'}</span>
                        <div class="stat-label">GB</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${fileTypeCount}</span>
                        <div class="stat-label">Types</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.results_count || 0}</span>
                        <div class="stat-label">Results</div>
                    </div>
                `;
            } else {
                // Fallback for old stats format
                inlineStatsDiv.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${stats.total_books || 0}</span>
                        <div class="stat-label">Books</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${Math.round((stats.total_size_mb || 0) / 1024 * 100) / 100}</span>
                        <div class="stat-label">GB</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.file_types || 0}</span>
                        <div class="stat-label">Types</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${stats.results_count || 0}</span>
                        <div class="stat-label">Results</div>
                    </div>
                `;
            }
            inlineStatsDiv.style.display = 'flex';
        }

        // Update search status text
        function updateSearchStatus() {
            const searchStatus = document.getElementById('search-status');
            const totalResults = window.allResults.length;
            const filteredCount = filteredResults.length;
            const timingText = window.serverSearchTime ? `<span class="search-timing">(${window.serverSearchTime}ms server)</span>` : '';
            
            if (activeFileTypes.size > 0) {
                const typeFilter = Array.from(activeFileTypes).map(ext => ext.toUpperCase().replace('.', '')).join(', ');
                searchStatus.innerHTML = `Showing ${filteredCount} of ${totalResults} results (${typeFilter} only) ${timingText}`;
            } else {
                searchStatus.innerHTML = `Found ${totalResults} results ${timingText}`;
            }
        }

        // Display paginated results (simplified - no longer needs to handle stats)
        function displayPaginatedResults(results, stats) {
            const resultsDiv = document.getElementById('results');
            
            // Handle empty results
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="message">No books match your search criteria.</div>';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(results.length / resultsPerPage);
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const currentResults = results.slice(startIndex, endIndex);
            
            // Display pagination info and controls
            const paginationHtml = totalPages > 1 ? `
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing ${startIndex + 1}-${Math.min(endIndex, results.length)} of ${results.length} results
                    </div>
                    <div class="pagination-controls">
                        <button class="btn-pagination" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>← Previous</button>
                        ${generatePageNumbers(currentPage, totalPages)}
                        <button class="btn-pagination" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next →</button>
                    </div>
                </div>
            ` : '';
            
            // Display current page results
            const resultsHtml = currentResults.map((book, index) => `
                <div class="result-item">
                    <div class="result-header">
                        <h3 class="result-title">${escapeHtml(book.filename)}</h3>
                        <div class="result-meta-top">
                            <span class="result-score">${book.score}%</span>
                            <span class="result-size">${book.size_mb} MB</span>
                            <span class="result-type">${book.extension.replace('.', '').toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="result-path">
                        <span class="result-path-text">${escapeHtml(book.full_path)}</span>
                        <button class="copy-path-btn" id="copy-btn-${index}" onclick="copyPath('${escapeHtml(book.full_path)}', 'copy-btn-${index}')">Copy</button>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.innerHTML = paginationHtml + '<div class="results-list">' + resultsHtml + '</div>' + (totalPages > 1 ? paginationHtml : '');
        }

        // Change page
        function changePage(page) {
            if (page < 1 || page > Math.ceil(filteredResults.length / resultsPerPage)) return;
            currentPage = page;
            displayPaginatedResults(filteredResults, window.allStats);
        }

        // Generate page numbers for pagination
        function generatePageNumbers(currentPage, totalPages) {
            let html = '';
            const maxVisiblePages = 5;
            
            if (totalPages <= maxVisiblePages) {
                // Show all pages if total is small
                for (let i = 1; i <= totalPages; i++) {
                    html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                }
            } else {
                // Show first page
                html += `<button class="btn-pagination ${1 === currentPage ? 'active' : ''}" onclick="changePage(1)">1</button>`;
                
                // Show ellipsis if needed
                if (currentPage > 3) {
                    html += '<span class="pagination-ellipsis">...</span>';
                }
                
                // Show pages around current page
                const start = Math.max(2, currentPage - 1);
                const end = Math.min(totalPages - 1, currentPage + 1);
                
                for (let i = start; i <= end; i++) {
                    html += `<button class="btn-pagination ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                }
                
                // Show ellipsis if needed
                if (currentPage < totalPages - 2) {
                    html += '<span class="pagination-ellipsis">...</span>';
                }
                
                // Show last page
                html += `<button class="btn-pagination ${totalPages === currentPage ? 'active' : ''}" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            return html;
        }

        // Display results (updated to use pagination)
        function displayResults(results, stats) {
            // This function now just calls the paginated version
            displayPaginatedResults(results, stats);
        }

        // Toggle file type filter (updated to work on results)
        function toggleFileType(ext, button) {
            if (activeFileTypes.has(ext)) {
                activeFileTypes.delete(ext);
                button.classList.remove('active');
            } else {
                activeFileTypes.add(ext);
                button.classList.add('active');
            }
            
            // Apply filters to current results
            applyFileTypeFilters();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show message
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            
            messagesDiv.appendChild(messageElement);
            
            setTimeout(() => {
                messageElement.remove();
            }, 5000);
        }

        // Load directories
        async function loadDirectories() {
            try {
                const response = await fetch('/directories');
                const data = await response.json();
                
                const listElement = document.getElementById('directory-list');
                listElement.innerHTML = '';
                
                data.valid_dirs.forEach(dir => {
                    const item = document.createElement('div');
                    item.className = 'directory-item';
                    item.innerHTML = `
                        <span class="directory-path">✓ ${dir}</span>
                        <button class="btn btn-danger directory-remove-btn" onclick="removeDirectory('${dir}')">Remove</button>
                    `;
                    listElement.appendChild(item);
                });

                data.invalid_dirs.forEach(dir => {
                    const item = document.createElement('div');
                    item.className = 'directory-item invalid';
                    item.innerHTML = `
                        <span class="directory-path">✗ ${dir}</span>
                        <button class="btn btn-danger directory-remove-btn" onclick="removeDirectory('${dir}')">Remove</button>
                    `;
                    listElement.appendChild(item);
                });
                
            } catch (error) {
                showMessage('Failed to load directories', 'error');
            }
        }

        // Add directory
        async function addDirectory() {
            const input = document.getElementById('new-directory');
            const directory = input.value.trim();
            
            if (!directory) return;
            
            try {
                const formData = new FormData();
                formData.append('directory', directory);
                
                const response = await fetch('/directories/add', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    input.value = '';
                    loadDirectories();
                    showMessage('Directory added successfully', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to add directory', 'error');
            }
        }

        // Remove directory
        async function removeDirectory(directory) {
            try {
                const formData = new FormData();
                formData.append('directory', directory);
                
                const response = await fetch('/directories/remove', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    loadDirectories();
                    showMessage('Directory removed successfully', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.detail, 'error');
                }
            } catch (error) {
                showMessage('Failed to remove directory', 'error');
            }
        }

        // Reset directories
        async function resetDirectories() {
            try {
                const response = await fetch('/directories/reset', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadDirectories();
                    showMessage('Directories reset to defaults', 'success');
                }
            } catch (error) {
                showMessage('Failed to reset directories', 'error');
            }
        }

        // Clear directories
        async function clearDirectories() {
            try {
                const response = await fetch('/directories/clear', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadDirectories();
                    showMessage('All directories cleared', 'success');
                }
            } catch (error) {
                showMessage('Failed to clear directories', 'error');
            }
        }

        // Force rebuild catalog
        async function forceBuildCatalog() {
            try {
                showMessage('Rebuilding catalog...', 'info');
                const formData = new FormData();
                formData.append('force_refresh', 'true');
                
                const response = await fetch('/catalog/build', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadCatalogInfo();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Failed to rebuild catalog', 'error');
            }
        }

        // Change results per page
        function changeResultsPerPage(value) {
            resultsPerPage = parseInt(value);
            currentPage = 1; // Reset to first page when changing results per page
            displayPaginatedResults(filteredResults, window.allStats);
        }

        // Copy path to clipboard
        async function copyPath(path, buttonId) {
            try {
                // Try modern Clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(path);
                } else {
                    // Fallback for older browsers or non-HTTPS
                    const tempInput = document.createElement('input');
                    tempInput.value = path;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                }
                
                // Find the button that was clicked and give visual feedback
                const buttons = document.querySelectorAll('.copy-path-btn');
                buttons.forEach(btn => {
                    if (btn.id === buttonId) {
                        btn.textContent = 'Copied!';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.textContent = 'Copy';
                            btn.classList.remove('copied');
                        }, 2000);
                    }
                });
                
                showMessage('Path copied to clipboard', 'info');
            } catch (error) {
                console.error('Failed to copy path:', error);
                showMessage('Failed to copy path', 'error');
            }
        }
    </script>
</body>
</html> 